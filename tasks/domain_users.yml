---
- name: domain_users | generate list of users
  command: "samba-tool user list"
  register: domain_users
  become: true

- name: domain_users | creating domain users
  block:
    - command: "samba-tool user add {{ item['name'] }} '{{ item['password'] }}'"
      become: true
      with_items: "{{ samba_domain_users }}"
      when: item['name'] not in domain_users['stdout']
  rescue:
    - debug:
        msg: "User {{ item['name'] }} already exists or another error occurred, skipping."
      with_items: "{{ samba_domain_users }}"
